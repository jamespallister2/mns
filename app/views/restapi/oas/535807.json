{
  "openapi": "3.0.0",
  "info": {
    "title": "Multicast Notification Service (MNS) - REST API",
    "version": "Computed and injected at build time by `scripts/set_version.py`",
    "description": "## Overview\n\n\n\n\nThis is the NHS publisher-subscriber or 'pub/sub' messaging solution, where lightweight messages or \"notifications\" are published by \"publishers\", and listening \"subscribers\" can receive those notifications.  \n\nSoftware development teams use the MNS API to publish and subscribe to, healthcare-related events.  \n\nThis API is currently only live with patient related events. Event notifications are published via MNS, and describe what type of event occurred. A pointer is provided in the notification message, to enable retrieval of all the details from the notification publishers API. \n\nEvent notifications are lightweight and they do not carry all the information about an event in their payload. Since notifications do not carry detailed personal information in the payload and the associated data protection risks are much lower if/when a data breach occurs. \n\nYou can subscribe to MNS events based on event type and optional corresponding criteria filters, ensuring that you only receive event notifications that you are interested in. \n\nIn order to get the details associated with an event notification an event subscriber must call the event publishers API.\n\nData flow:  \n    ![MNS High-level Diagram](https://raw.githubusercontent.com/NHSDigital/multicast-notification-service/master/assets/images/MNSOverview2.svg)\n\n\n  -  An event occurs on a event publishers' system. The system notifies MNS of an event occurring, along with a pointer to be used to retrieve further event details. \n  - MNS validates that the event conforms to the accepted schema and sends it another component to handle subscription matching and onward delivery\n  - MNS matches the signal against subscribing organisations and delivers it to their specified destinations, for example an AWS Kinesis Firehose. \n  - Subscribers will receive this as an event notification.\n  - Subscribers can use the details in the event notification to call the publisher's API and retrieve further details of the event. \n\n## The benefits of publishing events using MNS\n- MNS is an event-based service engine which allows you the owner of the source of truth to notify all interested parties in real-real time of an event that has updated the source of truth\n- MNS event notifications do not carry detailed personal information in the payload, so the associated data protection risks are much lower if/when a data breach occurs. MNS helps uphold data quality standards and compliance with GDPR and information governance.\n- MNS is an industry standard highly scalable decoupled and real-time event broker solution\n- Publishers can consume a common standard for notifications and can be free from developing point-to-point solutions for individual interested parties, whilst being assured that such interested parties have received the needed record change notification. \n- MNS avoids the custodian of data having to develop their own notification solution and having to 'onboard' each interested party to their solution \n\n\n## The benefits of using MNS as a subscriber\n- MNS is an event-based service engine which allows you to receive notifications about events your service needs in real time. It is the NHS's highly scalable, de-coupled, real-time event broker solution.\n- MNS helps you move from polling other software to the more modern pub-sub approach.\n- MNS allows subscribers to consume their events easily with their existing capabilities (e.g. through API or something more manual) \n- Publishers (owners) are a 'source of truth' for the events they publish. The events they are publishing are authoritative and accurate. By subscribing to their events, you can make your software's data more accurate and more authoritative.\n- Publishers of a data set notify you that an event has happened that has changed the data. You do not need to ask the publisher's API if anything has changed. You only call the publisher's API once you have been told something has changed. \n- When you receive an event notification, it includes a callback URL â€“ so your software will know which record to request from the publishers API \n- MNS is a common standard for notifications. Having a common standard for notifications should make it easier and quicker for you to integrate your software with multiple different NHS software teams.\n\n## Check before you start\nYou should only use the MNS platform if your team manages and develops a software product for use in the NHS. \nYour product is suitable to publish events using MNS if:\n- Your team manages and develops a software product for use in the NHS.\n- Your software product produces and stores new data.\n- Your software product produces data about patients (MNS is currently only publishing data about patients). For example appointments, prescriptions or observations about a patient. \n- The data you produce gets used by more than one other piece of software/product. \n- Your product has an API that can be called by any software receives and responds to your events (your 'subscribers'). They will do this to get the details of what has changed. Your software will decide if the subscriber is permitted to receive the details. \n\nYour product is suitable to subscribe to the MNS event notifications if:\n- Your software has a clear legal use case for receiving event notifications.\n- Your software will act on the notifications it receives.\n## Service level\nThis API is a bronze service, meaning it is operational and supported only during business hours (8am to 6pm), Monday to Friday excluding bank holidays\n## Getting started\nDuring the planned private beta this service will only be available to NHS England product teams.\n\n[Start publishing new MNS events from your software product](https://mns-demo-c29de763be62.herokuapp.com/start)\n\nHow to subscribe your software product to existing MNS events \n\n## API status and roadmap\nThis API is [in production (beta)](https://digital.nhs.uk/developer/guides-and-documentation/reference-guide#statuses).\nYou can comment, upvote and view progress on our [roadmap](https://nhs-digital-api-management.featureupvote.com/suggestions/440034/multicast-notification-service-event-management-api).\nFor more details, see [service levels](https://digital.nhs.uk/developer/guides-and-documentation/reference-guide#service-levels).\n## Technology\nThis API is a [REST-based](https://digital.nhs.uk/developer/guides-and-documentation/our-api-technologies#basic-rest) [publish-subscribe](https://digital.nhs.uk/developer/guides-and-documentation/introduction-to-healthcare-technology/integration-and-apis#publish-subscribe-events) API.\n\nThe signal structure is based on the recommendations of the [Cloud Events specification.](https://cloudevents.io/)\n## Network access\nThis API is available on the internet and, indirectly, on the [Health and Social Care Network (HSCN)](https://digital.nhs.uk/services/health-and-social-care-network).\n\nFor more details see [Network access for APIs](https://digital.nhs.uk/developer/guides-and-documentation/network-access-for-apis).\n## Security and authorisation\n\nThis API has one access mode:\n- application-restricted access\n\n### Application-restricted access\nUse this access mode if you need to publish an event from your system.\n\nThis access mode is [application-restricted](https://digital.nhs.uk/developer/guides-and-documentation/security-and-authorisation#application-restricted-apis), meaning we authenticate the calling application but not the end user.\n\nThe end user could be:\n* a healthcare worker - for example they record an event in an application and that application then publishes to MNS\n* a patient - for example they make a change to their record in a patient-facing application and that application then publishes to MNS\n* not present at all - for example as part of a back end process where events from an NHS England product or system are generated\n\nIn the above cases you must ensure the users are authenticated and suitably authorised locally\n\nTo use this access mode, use the following security pattern:\n* [Application-restricted RESTful API - signed JWT authentication](https://digital.nhs.uk/developer/guides-and-documentation/security-and-authorisation/application-restricted-restful-apis-signed-jwt-authentication)\n\n## Environments and testing\n\n| Environment       | Base URL                                                               |\n| ----------------- | ---------------------------------------------------------------------- |\n| Sandbox           | `https://sandbox.api.service.nhs.uk/multicast-notification-service`    |\n| Integration test  | `https://int.api.service.nhs.uk/multicast-notification-service`        |\n| Ref Environment   | `https://ref.api.service.nhs.uk/multicast-notification-service`        |\n| Production        | `https://api.service.nhs.uk/multicast-notification-service`            |\n\n### Sandbox testing\nOur [sandbox environment](https://digital.nhs.uk/developer/guides-and-documentation/testing#sandbox-testing):\n* is for early developer testing\n* only covers a limited set of scenarios\n* is stateless, so does not actually persist any updates\n* is open access, so does not allow you to test authorisation\n\nFor details of sandbox test scenarios, or to try out the sandbox using our 'Try this API' feature, see the documentation for each endpoint.\n\nAlternatively, you can try out the sandbox using our Postman collection (simply download the file from the link and import it into Postman):\n\n\n[![Run in Postman](https://run.pstmn.io/button.svg)](https://github.com/NHSDigital/multicast-notification-service/blob/master/postman/sandbox/Multicast_Notification_Sandbox.postman_collection.json)\n## Onboarding\nDuring the planned private beta this service will only be available to NHS England product teams. The onboarding process is in development and we will be\nimproving it iteratively as we gather feedback from the first set of users.\n\n## Errors\nWe use standard HTTP status codes to show whether an API request succeeded or not. They are usually in the range:\n\n* 200 to 299 if it succeeded, including code 202 if it was accepted by an API that needs to wait for further action\n* 400 to 499 if it failed because of a client error by your application\n* 500 to 599 if it failed because of an error on our server\n\nErrors specific to each API are shown in the Endpoints section, under Response. See our [reference guide](https://digital.nhs.uk/developer/guides-and-documentation/reference-guide#http-status-codes) for more on errors.\n\n## Open source\nYou might find the following [open source](https://digital.nhs.uk/developer/guides-and-documentation/reference-guide#open-source) resources useful:\n\n| Resource                  | Description                                                          | Links                                                                       |\n|---------------------------|----------------------------------------------------------------------|-----------------------------------------------------------------------------|\n| MNS API                   | Source code for the API proxy, sandbox and specification.            | [GitHub repo](https://github.com/NHSDigital/multicast-notification-service) |\n| FHIR libraries and SDKs   | Various open source libraries for integrating with FHIR APIs.        | [FHIR libraries and SDKs](https://digital.nhs.uk/developer/guides-and-documentation/api-technologies-at-nhs-digital#fhir-libraries-and-sdks) |\n\nWe currently don't have any open source client libraries or sample code for this API. If you think this would be useful, you can [upvote the suggestion on our Interactive Product Backlog](https://nhs-digital-api-management.featureupvote.com/suggestions/107439/client-libraries-and-reference-implementations).\n\nThe source code for the MNS back end is not currently in the open. If you think this would be useful, you can [upvote the suggestion on our Interactive Product Backlog](https://nhs-digital-api-management.featureupvote.com/suggestions/525770/open-source-the-multicast-notification-service-back-end-repo).\n",
    "contact": {
      "name": "multicast-notification-service API Support",
      "url": "https://digital.nhs.uk/developer/help-and-support",
      "email": "api.management@nhs.net"
    }
  },
  "security": [],
  "servers": [
    {
      "url": "https://sandbox.api.service.nhs.uk/multicast-notification-service",
      "description": "Sandbox environment."
    },
    {
      "url": "https://int.api.service.nhs.uk/multicast-notification-service",
      "description": "Integration test environment."
    },
    {
      "url": "https://api.service.nhs.uk/multicast-notification-service",
      "description": "Production environment."
    }
  ],
  "paths": {
    "/events": {
      "post": {
        "summary": "Publish an event",
        "description": "### Overview\nUse this endpoint to publish a healthcare-related event.\n\nThe event contains only a minimum dataset based on the recommendations of the [CloudEvents specification](https://github.com/cloudevents/spec/blob/v1.0.2/cloudevents/spec.md).\n\n### Data and Metadata:\n  - Metadata: In the context of an event, metadata refers to the additional information that describes the event and provides context about it. For example, for [PDS](https://digital.nhs.uk/services/personal-demographics-service) events it includes elements such as the family name and date of birth which are primarily for verification. Users must be cautious not to use such metadata to modify a patient's demographic details. Instead, if updates are necessary, users should conduct a full PDS retrieval to ensure accuracy and completeness in their workflows.\n  - Data: The inclusion of the data field might vary. Its presence is subject to agreements between the MNS team and the originating system. While the structure of the data might differ across various systems and scenarios, it's a general preference to have a pointer included. This pointer aids subscribers in accessing the entire record when necessary for their workflow.\n\n### Sandbox testing\nYou can test the following scenarios in our sandbox environment:\n\n| Scenario                                  | Request                                                                 | Response                                                       |\n| ----------------------------------------- | ----------------------------------------------------------------------- | -------------------------------------------------------------- |\n| Publish a GP Registration Change event    | Content-Type: `application/json` Event Type: `pds-change-of-gp-1`       | HTTP Status 200 and response containing id and success status. |\n| Publish a GP Death event                  | Content-Type: `application/json` Event Type: `pds-death-notification-1` | HTTP Status 200 and response containing id and success status. |\n| Publish an NHS Number Change event        | Content-Type: `application/json` Event Type: `nhs-number-change-1`      | HTTP Status 200 and response containing id and success status. |\n| Publish an Immunisation Vaccination event | Content-Type: `application/json` Event Type: `imms-vaccinations-1`      | HTTP Status 200 and response containing id and success status. |\n| Publish an event with invalid data        | E.g. an event with an invalid value for `time`                          | HTTP Status 400 and response containing a validation error.    |\n\nYou can try out the sandbox using the 'Try this API' feature on this page.\n",
        "operationId": "publish-event",
        "parameters": [
          {
            "name": "Authorization",
            "in": "header",
            "required": true,
            "description": "An [OAuth 2.0 bearer token](https://digital.nhs.uk/developer/guides-and-documentation/security-and-authorisation/application-restricted-restful-apis-signed-jwt-authentication).\nRequired in all environments except sandbox.",
            "schema": {
              "type": "string",
              "format": "^Bearer [[:ascii:]]+$",
              "example": "Bearer g1112R_ccQ1Ebbb4gtHBP1aaaNM"
            }
          },
          {
            "name": "X-Correlation-ID",
            "in": "header",
            "required": true,
            "description": "An ID which is used to track transactions across multiple systems. It can take any value, but we recommend avoiding `.` characters.\nMirrored back in a response header.",
            "schema": {
              "type": "string",
              "example": "11C46F5F-CDEF-4865-94B2-0EE0EDCC26DA"
            }
          },
          {
            "name": "Content-Type",
            "in": "header",
            "required": true,
            "description": "The content type of the request body.\nThis is used to determine validation on the event body and should be set to `application/cloudevents+json` unless the event is a legacy event where it should be `application/json`.",
            "schema": {
              "type": "string",
              "example": "application/cloudevents+json"
            }
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/cloudevents+json": {
              "schema": {
                "oneOf": [
                  {
                    "$ref": "#/components/schemas/gpreg-change-gp-req-1"
                  },
                  {
                    "$ref": "#/components/schemas/patientflags-change-1"
                  }
                ],
                "discriminator": {
                  "propertyName": "type"
                }
              },
              "examples": {
                "gpreg-change-gp-req-1": {
                  "description": "Create a GP Registration Change event",
                  "value": {
                    "specversion": "1.0",
                    "id": "236a1d4a-5d69-4fa9-9c7f-e72bf505aa5b",
                    "source": "uk.nhs.register-with-a-gp-surgery-service",
                    "type": "gpreg-change-gp-req-1",
                    "time": "2020-06-01T13:00:00Z",
                    "dataref": "https://api.service.nhs.uk/register-with-a-gp-surgery/applications/236a1d4a-5d69-4fa9-9c7f-e72bf505aa5b",
                    "subject": "9912003888",
                    "filtering": {
                      "registrationencountercode": "3",
                      "generalpractitioner": "XY11"
                    }
                  }
                },
                "patientflags-change-1": {
                  "description": "Create a Patient Flags Change event",
                  "value": {
                    "specversion": "1.0",
                    "id": "16dbfb42-b5c0-4831-8258-f1a4d2491748",
                    "source": "uk.nhs.patient-flags-service",
                    "type": "patientflags-change-1",
                    "time": "2020-06-01T13:00:00Z",
                    "dataref": "https://api.service.nhs.uk/patient-flags-api/PatientFlag?patient=9912003888&code=NRAF",
                    "subject": "9912003888",
                    "filtering": {
                      "flagtype": "NRAF",
                      "generalpractitioner": "XY11"
                    }
                  }
                }
              }
            },
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "id",
                  "type",
                  "subject",
                  "source",
                  "time"
                ],
                "properties": {
                  "id": {
                    "type": "string",
                    "description": "Publishers must ensure that the id is unique within their system to ensure that when the MNS team trace messages, they can be certain that source + id will be unique. UUIDv4 format is expected."
                  },
                  "type": {
                    "type": "string",
                    "description": "A unique string representing the event type."
                  },
                  "subject": {
                    "type": "object",
                    "description": "The healthcare entity to which the event occurred. For example, this could be an NHS organisation or a person such as an NHS patient or member of staff.\nWe currently only have a schema for a patient as a subject but will work with you to agree a new schema if you have a different use case.\n",
                    "oneOf": [
                      {
                        "$ref": "components/schemas/cloudevents/eventSubjectPatientExample.yaml"
                      }
                    ]
                  },
                  "source": {
                    "type": "object",
                    "required": [
                      "name",
                      "identifier"
                    ],
                    "description": "Organisation responsible for publishing the event.",
                    "properties": {
                      "name": {
                        "type": "string",
                        "description": "Organisation name"
                      },
                      "identifier": {
                        "type": "object",
                        "required": [
                          "system",
                          "value"
                        ],
                        "description": "Must follow this identifier system: https://fhir.nhs.uk/Id/nhsSpineASID and provide the ASID Code as the value.",
                        "properties": {
                          "system": {
                            "type": "string"
                          },
                          "value": {
                            "type": "string"
                          }
                        }
                      }
                    }
                  },
                  "time": {
                    "type": "string",
                    "format": "date-time",
                    "description": "The time at which the signal is published. This must be a compliant RFC3339 datetime in line with the FHIR standard for [system instants](https://hl7.org/fhir/R4/datatypes.html#instant). This means it can have seconds or milliseconds precision."
                  },
                  "data": {
                    "type": "object",
                    "description": "This field is optional, dependent on the agreements between the publishing system and the MNS team. While the data schema might vary based on the system and use-case, it is preferred to include a pointer for subscribers to access the full record when necessary for their workflow.",
                    "oneOf": [
                      {
                        "$ref": "components/schemas/cloudevents/pdsChangeOfGpEventData.yaml"
                      },
                      {
                        "$ref": "components/schemas/cloudevents/pdsDeathEventData.yaml"
                      },
                      {
                        "$ref": "components/schemas/cloudevents/nhsNumberChangeEventData.yaml"
                      },
                      {
                        "$ref": "components/schemas/cloudevents/immunisationVaccinationEventData.yaml"
                      }
                    ]
                  }
                }
              },
              "examples": {
                "pdsChangeOfGpEvent": {
                  "description": "Create a PDS change of GP signal event",
                  "value": {
                    "id": "236a1d4a-5d69-4fa9-9c7f-e72bf505aa5b",
                    "type": "pds-change-of-gp-1",
                    "subject": {
                      "nhsNumber": "9912003888",
                      "familyName": "DAWKINS",
                      "dob": "2017-10-02"
                    },
                    "source": {
                      "name": "NHS Digital",
                      "identifier": {
                        "system": "https://fhir.nhs.uk/Id/nhsSpineASID",
                        "value": "477121000324"
                      }
                    },
                    "time": "2022-04-05T17:31:00.000Z",
                    "data": {
                      "versionId": "W/\"2\"",
                      "fullUrl": "https://int.api.service.nhs.uk/personal-demographics/FHIR/R4/Patient/9912003888",
                      "registrationEncounterCode": "3",
                      "provenance": {
                        "name": "The GP Practice",
                        "identifier": {
                          "system": "https://fhir.nhs.uk/Id/nhsSpineASID",
                          "value": "477121000323"
                        }
                      }
                    }
                  }
                },
                "pdsDeathEvent": {
                  "value": {
                    "id": "236a1d4a-5d69-4fa9-9c7f-e72bf505aa5b",
                    "type": "pds-death-notification-1",
                    "subject": {
                      "dob": "2017-10-02",
                      "familyName": "DAWKINS",
                      "nhsNumber": "9912003888"
                    },
                    "source": {
                      "name": "NHS DIGITAL",
                      "identifier": {
                        "system": "https://fhir.nhs.uk/Id/nhsSpineASID",
                        "value": "477121000324"
                      }
                    },
                    "time": "2022-04-05T17:31:00.000Z",
                    "data": {
                      "versionId": "W/\"16\"",
                      "fullUrl": "https://int.api.service.nhs.uk/personal-demographics/FHIR/R4/Patient/9912003888",
                      "deathNotificationStatus": "2",
                      "provenance": {
                        "name": "The GP Practice",
                        "identifier": {
                          "system": "https://fhir.nhs.uk/Id/nhsSpineASID",
                          "value": "477121000323"
                        }
                      }
                    }
                  }
                },
                "nhsNumberChangeEvent": {
                  "value": {
                    "id": "dd822a88-959c-416c-86e0-652a48c5a810",
                    "type": "nhs-number-change-1",
                    "subject": {
                      "dob": "2017-10-02",
                      "familyName": "DAWKINS",
                      "nhsNumber": "9912003888"
                    },
                    "source": {
                      "name": "NHS DIGITAL",
                      "identifier": {
                        "system": "https://fhir.nhs.uk/Id/nhsSpineASID",
                        "value": "477121000324"
                      }
                    },
                    "time": "2022-04-05T17:31:00.000Z",
                    "data": {
                      "versionId": "W/\"16\"",
                      "fullUrl": "https://int.api.service.nhs.uk/personal-demographics/FHIR/R4/Patient/9912003888",
                      "nhsNumberStatus": "I",
                      "provenance": {
                        "name": "The GP Practice",
                        "identifier": {
                          "system": "https://fhir.nhs.uk/Id/nhsSpineASID",
                          "value": "477121000323"
                        }
                      }
                    }
                  }
                },
                "immunisationVaccinationEvent": {
                  "value": {
                    "id": "93d3f828-c6d2-43eb-95c2-f98f7c7ed889",
                    "type": "imms-vaccinations-1",
                    "subject": {
                      "dob": "2017-10-02",
                      "familyName": "DAWKINS",
                      "nhsNumber": "9912003888"
                    },
                    "source": {
                      "name": "NHS DIGITAL",
                      "identifier": {
                        "system": "https://fhir.nhs.uk/Id/immunisationsASID",
                        "value": "477121000324"
                      }
                    },
                    "time": "2022-04-05T17:31:00.000Z",
                    "data": {
                      "versionId": "W/\"1\"",
                      "fullUrl": "https://int.api.service.nhs.uk/immunisation-fhir-api/Immunization?patient.identifier=https%3A%2F%2Ffhir.nhs.uk%2FId%2Fnhs-number%7C9912003888",
                      "immunisationType": "FLU",
                      "provenance": {
                        "name": "The GP Practice",
                        "identifier": {
                          "system": "https://fhir.nhs.uk/Id/orignatorOfRecordASID",
                          "value": "477121000323"
                        }
                      }
                    }
                  }
                },
                "mnsEventMetaDataOnly": {
                  "value": {
                    "id": "236a1d4a-5d69-4fa9-9c7f-e72bf505aa5b",
                    "type": "possible-future-event-containing-no-data-field",
                    "subject": {
                      "nhsNumber": "A new subject schema would need to be proposed for subjects other than patients.",
                      "familyName": "DAWKINS",
                      "dob": "2017-10-02"
                    },
                    "source": {
                      "name": "NHS Digital",
                      "identifier": {
                        "system": "https://fhir.nhs.uk/Id/nhsSpineASID",
                        "value": "477121000324"
                      }
                    },
                    "time": "2022-04-05T17:31:00.000Z"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Success - the event is accepted and will be multicast to subscribers",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "id": {
                      "type": "string",
                      "description": "The id provided in the user's payload",
                      "example": "236a1d4a-5d69-4fa9-9c7f-e72bf505aa5b"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Invalid user input",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "validationErrors": {
                      "type": "object",
                      "description": "Object containing the different errors on a per key basis",
                      "properties": {
                        "type": {
                          "type": "string",
                          "example": "Please provide a valid event type"
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "components/errors/unauthenticated-error.yaml"
          },
          "403": {
            "description": "Unauthorized error",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "errors": {
                      "type": "string",
                      "description": "Error string that explains the problem",
                      "example": "User is not authorized to handle the requested event type"
                    }
                  }
                }
              }
            }
          },
          "500": {
            "$ref": "components/errors/internal-error.yaml"
          }
        }
      }
    },
    "/subscriptions": {
      "post": {
        "summary": "Subscribe to events",
        "description": "### Overview\nUse this endpoint to subscribe to healthcare-related signals. You can view details of the available signals on our [Signal Catalogue page](https://digital.nhs.uk/developer/api-catalogue/multicast-notification-service/signal-catalogue).\n\n### Subscription filtering\nYou can filter the signals you want to receive using the `criteria` field in the payload. As a minimum, you must specify the event type. For example, if you provide `eventType=pds-change-of-gp-1`\nthis will mean that you receive all PDS Change of GP events. Depending on the event, additional filters are available, for example you can filter by `generalpractitioner`,`registrationencountercode` or `supplierNACS` for `gpreg-change-gp-req-1` event.\nWe are working with publishers and subscribers during private beta to identify any other useful filters for existing and future event types.\n\nFor further information refer to the payload schema below.\n\n### Subscription delivery\nYou can specify the endpoint you want signals delivered to using the `channel.endpoint` field in the payload. MNS currently only supports delivery to [AWS SQS](https://aws.amazon.com/sqs/) endpoints and\n[MESH](https://digital.nhs.uk/services/message-exchange-for-social-care-and-health-mesh) mailboxes. We are working with users during private beta to identify other potential delivery endpoints.\nThere may be further delivery endpoints available in future.\n\nYou can make suggestions using [feature upvote](https://nhs-digital-api-management.featureupvote.com).\n\n#### SQS Delivery\nBefore signals can be delivered to your SQS queue, you will need to complete some configuration steps during onboarding e.g. policy and encryption setup. When you make a create subscription request, you must provide your\nfull SQS ARN.\n\n#### MESH Delivery\nYou will need to provide the ID of your MESH mailbox during onboarding. If you have already completed [MESH onboarding](https://digital.nhs.uk/developer/api-catalogue/message-exchange-for-social-care-and-health-api#overview--end-to-end-process-to-integrate-with-mesh-api)\nthen no further steps will be required aside from calling the subscriptions API. Use a MESH mailbox from their 'Path to Live integration' environment for all non-production MNS environments and a production mailbox for production MNS.\n\nThe mailbox ID and workflow ID you require are supplied to the `channel.endpoint` field in a `mesh://` URL scheme.\n\ne.g. `mesh://MYMAILBOXOT101?workflow_id=myWorkflow101` specifies the mailbox ID `MYMAILBOXOT101` and the workflow ID `myWorkflow101`.\n\n### Sandbox testing\nYou can test the following scenarios in our sandbox environment:\n\n| Scenario                                  | Request                                                                  | Response                                                                    |\n| ----------------------------------------- | ------------------------------------------------------------------------ | --------------------------------------------------------------------------- |\n| Subscribe to GP registration changes      | Content-Type: `application/fhir+json`                                    | HTTP Status 201 and response containing the id of the subscription created. |\n| Subscribe to NHS number changes           | Content-Type: `application/fhir+json`                                    | HTTP Status 201 and response containing the id of the subscription created. |\n| Subscribe to PDS death notifications      | Content-Type: `application/fhir+json`                                    | HTTP Status 201 and response containing the id of the subscription created. |\n| Publish a subscription with invalid data  | E.g. modify the subscription to have an invalid value for `resourceType` | HTTP Status 400 and response containing a validation error.                 |\n\nYou can try out the sandbox using the 'Try this API' feature on this page.\n",
        "operationId": "create-subscription",
        "parameters": [
          {
            "name": "Authorization",
            "in": "header",
            "required": true,
            "description": "An [OAuth 2.0 bearer token](https://digital.nhs.uk/developer/guides-and-documentation/security-and-authorisation/application-restricted-restful-apis-signed-jwt-authentication).\nRequired in all environments except sandbox.",
            "schema": {
              "type": "string",
              "format": "^Bearer [[:ascii:]]+$",
              "example": "Bearer g1112R_ccQ1Ebbb4gtHBP1aaaNM"
            }
          },
          {
            "name": "X-Correlation-ID",
            "in": "header",
            "required": true,
            "description": "An ID which is used to track transactions across multiple systems. It can take any value, but we recommend avoiding `.` characters.\nMirrored back in a response header.",
            "schema": {
              "type": "string",
              "example": "11C46F5F-CDEF-4865-94B2-0EE0EDCC26DA"
            }
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/fhir+json": {
              "schema": {
                "type": "object",
                "required": [
                  "resourceType",
                  "status",
                  "reason",
                  "criteria",
                  "channel"
                ],
                "properties": {
                  "resourceType": {
                    "type": "string",
                    "description": "The subscription FHIR Resource: https://hl7.org/fhir/R4/subscription.html"
                  },
                  "status": {
                    "type": "string",
                    "description": "The status of the subscription. When creating a subscription, the value must be `requested`."
                  },
                  "end": {
                    "type": "string",
                    "format": "date-time",
                    "description": "Optional expiry date/time for the subscription. As per the [FHIR R4 instant data type](https://hl7.org/fhir/R4/datatypes.html#instant) time shall be specified to at least the second and include a time zone.\nFor example: YYYY-MM-DDThh:mm:ss.sss+zz:zz (e.g. 2015-02-07T13:28:17.239+02:00 or 2017-01-01T00:00:00Z)\n"
                  },
                  "reason": {
                    "type": "string",
                    "description": "A description of why this subscription is required. You may provide an empty string."
                  },
                  "criteria": {
                    "type": "string",
                    "description": "Criteria for the subscription. Provide your criteria with each condition separated by `&;`. If you are requesting a generic subscription to all signals of a certain type the separator is not required. For example, `eventType=gpreg-change-gp-req-1&;generalpractitioner=XY11`\nor `eventType=gpreg-change-gp-req-1`. A valid criteria must contain a permitted value for `eventType`. Additional criteria depends on the event and are documentated on our [Signal Catalogue page](https://digital.nhs.uk/developer/api-catalogue/multicast-notification-service/signal-catalogue).\n"
                  },
                  "channel": {
                    "type": "object",
                    "required": [
                      "type",
                      "endpoint",
                      "payload"
                    ],
                    "description": "The channel on which to report matches to the criteria. SQS Endpoints must be unique per event type; attempts to add a subscription with an endpoint which is already in-use will fail with a HTTP 409 (Conflict)",
                    "properties": {
                      "type": {
                        "type": "string",
                        "description": "The type of channel to send notifications on. Of the options within [FHIR](https://hl7.org/fhir/R4/valueset-subscription-channel-type.html), MNS currently only supports `message`."
                      },
                      "endpoint": {
                        "type": "string",
                        "description": "The endpoint which signals will be delivered to. MNS currently only supports delivery to [MESH](https://digital.nhs.uk/services/message-exchange-for-social-care-and-health-mesh) mailboxes and [AWS SQS](https://aws.amazon.com/sqs/) endpoints. Note: for MESH delivery you must provide the full mailbox ID and for SQS delivery you must provide the full SQS ARN of your desired queue."
                      },
                      "payload": {
                        "type": "string",
                        "description": "The mime type to send the payload in. MNS supports `application/json` and `application/fhir+json` (FHIR R4 Bundle)."
                      }
                    }
                  },
                  "hydration": {
                    "type": "object",
                    "required": [
                      "enabled"
                    ],
                    "description": "Optional block to configure hydration properties - hydration is disabled by default.",
                    "properties": {
                      "enabled": {
                        "type": "boolean",
                        "description": "A flag to enable (true) or disable (false) signal hydration."
                      },
                      "headers": {
                        "type": "object",
                        "description": "An optional dictionary of HTTP headers that will be sent in the request to the API endpoint specified in the signal.",
                        "additionalProperties": {
                          "type": "string",
                          "description": "HTTP header that will be sent in the request to the API endpoint specified in the signal."
                        }
                      }
                    }
                  }
                }
              },
              "examples": {
                "pdsChangeofGPSubscription": {
                  "description": "Create a pds change of GP subscription",
                  "value": {
                    "resourceType": "Subscription",
                    "status": "requested",
                    "end": "2022-04-05T17:31:00.000Z",
                    "reason": "A description of why this subscription should be created.",
                    "criteria": "eventType=pds-change-of-gp-1",
                    "channel": {
                      "type": "message",
                      "endpoint": "arn:aws:sqs:eu-west-2:123456789012:queue1",
                      "payload": "application/json"
                    }
                  }
                },
                "pdsChangeofGPSubscriptionMeshDelivery": {
                  "description": "Create a pds change of GP subscription with MESH delivery",
                  "value": {
                    "resourceType": "Subscription",
                    "status": "requested",
                    "end": "2022-04-05T17:31:00.000Z",
                    "reason": "A description of why this subscription should be created.",
                    "criteria": "eventType=pds-change-of-gp-1",
                    "channel": {
                      "type": "message",
                      "endpoint": "mesh://MYMAILBOXOT101?workflow_id=myWorkflow101",
                      "payload": "application/json"
                    }
                  }
                },
                "nhsNumberChangeSubscription": {
                  "description": "Create an NHS number change subscription",
                  "value": {
                    "resourceType": "Subscription",
                    "status": "requested",
                    "end": "2022-04-05T17:31:00.000Z",
                    "reason": "A description of why this subscription should be created.",
                    "criteria": "eventType=nhs-number-change-1",
                    "channel": {
                      "type": "message",
                      "endpoint": "arn:aws:sqs:eu-west-2:123456789012:queue2",
                      "payload": "application/json"
                    }
                  }
                },
                "pdsDeathNotificationSubscription": {
                  "description": "Create a pds death notification subscription",
                  "value": {
                    "resourceType": "Subscription",
                    "status": "requested",
                    "end": "2022-04-05T17:31:00.000Z",
                    "reason": "A description of why this subscription should be created.",
                    "criteria": "eventType=pds-death-notification-1",
                    "channel": {
                      "type": "message",
                      "endpoint": "arn:aws:sqs:eu-west-2:123456789012:queue2",
                      "payload": "application/fhir+json"
                    }
                  }
                },
                "immunisationVaccinationSubscription": {
                  "description": "Create an immunisation vaccination subscription",
                  "value": {
                    "resourceType": "Subscription",
                    "status": "requested",
                    "end": "2022-04-05T17:31:00.000Z",
                    "reason": "A description of why this subscription should be created.",
                    "criteria": "eventType=imms-vaccinations-1",
                    "channel": {
                      "type": "message",
                      "endpoint": "arn:aws:sqs:eu-west-2:123456789012:queue2",
                      "payload": "application/json"
                    }
                  }
                },
                "validatedGPRegistrationRequestSubscription": {
                  "description": "Create a validated GP registration request event subscription",
                  "value": {
                    "resourceType": "Subscription",
                    "status": "requested",
                    "end": "2022-04-05T17:31:00.000Z",
                    "reason": "A description of why this subscription should be created.",
                    "criteria": "eventType=gpreg-change-gp-req-1&;supplierNACS=Y12345&;registrationencountercode=3",
                    "channel": {
                      "type": "message",
                      "endpoint": "arn:aws:sqs:eu-west-2:123456789012:queue2",
                      "payload": "application/fhir+json"
                    }
                  }
                },
                "patientflagsChangeSubscription": {
                  "description": "Create a Patient Flags Change subscription",
                  "value": {
                    "resourceType": "Subscription",
                    "status": "requested",
                    "end": "2022-04-05T17:31:00.000Z",
                    "reason": "A description of why this subscription should be created.",
                    "criteria": "eventType=patientflags-change-1&;flagtype=NRAF&;generalpractitioner=XY11",
                    "channel": {
                      "type": "message",
                      "endpoint": "arn:aws:sqs:eu-west-2:123456789012:queue2",
                      "payload": "application/fhir+json"
                    }
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Created - the subscription has been successfully created",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "id": {
                      "type": "string",
                      "description": "The subscription UUID created by the system",
                      "example": "236a1d4a-5d69-4fa9-9c7f-e72bf505aa5b"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Invalid user input",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "validationErrors": {
                      "type": "object",
                      "description": "Object containing the different errors on a per key basis",
                      "properties": {
                        "resourceType": {
                          "type": "string",
                          "example": "Please provide the correct resource type for this endpoint"
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "components/errors/unauthenticated-error.yaml"
          },
          "403": {
            "description": "Unauthorized error",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "errors": {
                      "type": "string",
                      "description": "Error string that explains the problem",
                      "example": "User is not authorized to handle the requested data type"
                    }
                  }
                }
              }
            }
          },
          "409": {
            "description": "Resource conflict",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "errors": {
                      "type": "string",
                      "description": "Error string that explains the problem",
                      "example": "Endpoint arn:aws:sqs:eu-west-2:12345:queue-name is already subscribed for pds-change-of-gp-1 events"
                    }
                  }
                }
              }
            }
          },
          "500": {
            "$ref": "components/errors/internal-error.yaml"
          }
        }
      },
      "get": {
        "summary": "Get all subscriptions",
        "description": "### Overview\nUse this endpoint to retrieve a list of all subscriptions belonging to you.\nIf your application does not own any subscriptions, then this endpoint will return an empty list.\nThe list of subscriptions is presented in a FHIR resource bundle, allowing pagination. \n### Sandbox testing\nYou can test the following scenarios in our sandbox environment:\n| Scenario                                  | Request                                                                  | Response                                                                    |\n| ----------------------------------------- | ------------------------------------------------------------------------ | --------------------------------------------------------------------------- |\n| User has a list of subscriptions          | `GET` request                                                            | HTTP Status 200 containing a list of subscription resources                 |\nYou can try out the sandbox using the 'Try this API' feature on this page.\n",
        "operationId": "get-all-subscriptions",
        "parameters": [
          {
            "name": "Authorization",
            "in": "header",
            "required": true,
            "description": "An [OAuth 2.0 bearer token](https://digital.nhs.uk/developer/guides-and-documentation/security-and-authorisation/application-restricted-restful-apis-signed-jwt-authentication).\nRequired in all environments except sandbox.",
            "schema": {
              "type": "string",
              "format": "^Bearer [[:ascii:]]+$",
              "example": "Bearer g1112R_ccQ1Ebbb4gtHBP1aaaNM"
            }
          },
          {
            "name": "X-Correlation-ID",
            "in": "header",
            "required": true,
            "description": "An ID which is used to track transactions across multiple systems. It can take any value, but we recommend avoiding `.` characters.\nMirrored back in a response header.",
            "schema": {
              "type": "string",
              "example": "11C46F5F-CDEF-4865-94B2-0EE0EDCC26DA"
            }
          },
          {
            "name": "continue_from",
            "in": "query",
            "required": false,
            "description": "An optional query string parameter used for pagination, specifying the point from which to continue the list.",
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Successfully retrieved list of subscriptions",
            "content": {
              "application/fhir+json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "resourceType": {
                      "type": "string",
                      "enum": [
                        "Bundle"
                      ]
                    },
                    "type": {
                      "type": "string",
                      "enum": [
                        "searchset"
                      ]
                    },
                    "link": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "relation": {
                            "type": "string",
                            "description": "Relation type, e.g., 'self', 'next'. The 'next' relation is present only if there's additional content to paginate through."
                          },
                          "url": {
                            "type": "string",
                            "description": "The URL for the relation. For 'next', this URL points to the next page of results."
                          }
                        },
                        "example": {
                          "relation": "next",
                          "url": "/subscriptions?continue_from=ZmRqa2xmZGprc2xmamtsZHNqZmxkc2Zkcw=="
                        }
                      }
                    },
                    "entry": {
                      "type": "array",
                      "items": {
                        "$ref": "components/schemas/fhir/R4/Subscription.yaml"
                      }
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Invalid user input",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "errors": {
                      "type": "string",
                      "description": "Error string that explains the problem",
                      "example": "The continue_from field was not valid"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "components/errors/unauthenticated-error.yaml"
          },
          "403": {
            "$ref": "components/errors/unauthorised-error.yaml"
          },
          "500": {
            "$ref": "components/errors/internal-error.yaml"
          }
        }
      }
    },
    "/subscriptions/{id}": {
      "get": {
        "summary": "Get subscription details",
        "description": "### Overview\nUse this endpoint to retrieve details of a subscription belonging to you.\n### Sandbox testing\nYou can test the following scenarios in our sandbox environment:\n| Scenario                                  | Request                                                                  | Response                                                                    |\n| ----------------------------------------- | ------------------------------------------------------------------------ | --------------------------------------------------------------------------- |\n| Subscription exists and can be retrieved  | `id=e9050741-ae87-4720-beb1-2abd9248e227`                                | HTTP Status 200 containing subscription details                             |\n| Subscription does not exist               | `id=236a1d4a-5d69-4fa9-9c7f-e72bf505aa5b` (or any other valid UUID)      | HTTP Status 404 containing problem description                              |\nYou can try out the sandbox using the 'Try this API' feature on this page.\n",
        "operationId": "get-subscription-by-id",
        "parameters": [
          {
            "name": "Authorization",
            "in": "header",
            "required": true,
            "description": "An [OAuth 2.0 bearer token](https://digital.nhs.uk/developer/guides-and-documentation/security-and-authorisation/application-restricted-restful-apis-signed-jwt-authentication).\nRequired in all environments except sandbox.",
            "schema": {
              "type": "string",
              "format": "^Bearer [[:ascii:]]+$",
              "example": "Bearer g1112R_ccQ1Ebbb4gtHBP1aaaNM"
            }
          },
          {
            "name": "X-Correlation-ID",
            "in": "header",
            "required": true,
            "description": "An ID which is used to track transactions across multiple systems. It can take any value, but we recommend avoiding `.` characters.\nMirrored back in a response header.",
            "schema": {
              "type": "string",
              "example": "11C46F5F-CDEF-4865-94B2-0EE0EDCC26DA"
            }
          },
          {
            "name": "id",
            "in": "path",
            "required": true,
            "description": "The ID of the subscription you want to retrieve. The ID will be a valid UUID (v4).",
            "schema": {
              "type": "string",
              "example": "e9050741-ae87-4720-beb1-2abd9248e227"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Successfully got subscription details",
            "content": {
              "application/fhir+json": {
                "schema": {
                  "$ref": "components/schemas/fhir/R4/Subscription.yaml"
                }
              }
            }
          },
          "400": {
            "description": "Invalid user input",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "errors": {
                      "type": "string",
                      "description": "Error string that explains the problem",
                      "example": "Please provide a valid subscription ID"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "components/errors/unauthenticated-error.yaml"
          },
          "403": {
            "$ref": "components/errors/unauthorised-error.yaml"
          },
          "404": {
            "$ref": "components/errors/not-found-error.yaml"
          },
          "500": {
            "$ref": "components/errors/internal-error.yaml"
          }
        }
      },
      "delete": {
        "summary": "Delete a subscription",
        "description": "### Overview\nUse this endpoint to delete a subscription that you need to remove.\n\n### Sandbox testing\nYou can test the following scenarios in our sandbox environment:\n\n| Scenario                                  | Request                                                                  | Response                                                                    |\n| ----------------------------------------- | ------------------------------------------------------------------------ | --------------------------------------------------------------------------- |\n| Subscription exists and can be deleted    | `id=e9050741-ae87-4720-beb1-2abd9248e227`                                | HTTP Status 204 resource deleted response                                    |\n| Subscription does not exist               | `id=236a1d4a-5d69-4fa9-9c7f-e72bf505aa5b` (or any other valid UUID)      | HTTP Status 404 containing problem description                              |\n\nYou can try out the sandbox using the 'Try this API' feature on this page.\n",
        "operationId": "delete-subscription",
        "parameters": [
          {
            "name": "Authorization",
            "in": "header",
            "required": true,
            "description": "An [OAuth 2.0 bearer token](https://digital.nhs.uk/developer/guides-and-documentation/security-and-authorisation/application-restricted-restful-apis-signed-jwt-authentication).\nRequired in all environments except sandbox.",
            "schema": {
              "type": "string",
              "format": "^Bearer [[:ascii:]]+$",
              "example": "Bearer g1112R_ccQ1Ebbb4gtHBP1aaaNM"
            }
          },
          {
            "name": "X-Correlation-ID",
            "in": "header",
            "required": true,
            "description": "An ID which is used to track transactions across multiple systems. It can take any value, but we recommend avoiding `.` characters.\nMirrored back in a response header.",
            "schema": {
              "type": "string",
              "example": "11C46F5F-CDEF-4865-94B2-0EE0EDCC26DA"
            }
          },
          {
            "name": "id",
            "in": "path",
            "required": true,
            "description": "The ID of the subscription you want to delete. The ID will be a valid UUID (v4).",
            "schema": {
              "type": "string",
              "example": "e9050741-ae87-4720-beb1-2abd9248e227"
            }
          }
        ],
        "responses": {
          "204": {
            "description": "The subscription was deleted"
          },
          "400": {
            "description": "Invalid user input",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "errors": {
                      "type": "string",
                      "description": "Error string that explains the problem",
                      "example": "Please provide a valid subscription ID"
                    }
                  }
                }
              }
            }
          },
          "401": {
            "$ref": "components/errors/unauthenticated-error.yaml"
          },
          "403": {
            "$ref": "components/errors/unauthorised-error.yaml"
          },
          "404": {
            "$ref": "components/errors/not-found-error.yaml"
          },
          "500": {
            "$ref": "components/errors/internal-error.yaml"
          }
        }
      }
    }
  },
  "components": {
    "schemas": {
      "cloudevent": {
        "$ref": "components/schemas/cloudevents/baseMnsCloudEventSignal.yaml",
        "discriminator": {
          "propertyName": "type"
        }
      },
      "gpreg-change-gp-req-1": {
        "description": "gpreg-change-gp-req-1",
        "allOf": [
          {
            "$ref": "#/components/schemas/cloudevent"
          },
          {
            "type": "object",
            "properties": {
              "filtering": {
                "$ref": "components/schemas/filtering/gpreg-change-gp-req-1-filtering.yaml"
              }
            },
            "required": [
              "filtering",
              "subject"
            ]
          }
        ]
      },
      "patientflags-change-1": {
        "description": "patientflags-change-1",
        "allOf": [
          {
            "$ref": "#/components/schemas/cloudevent"
          },
          {
            "type": "object",
            "properties": {
              "filtering": {
                "$ref": "components/schemas/filtering/patientflags-change-1-filtering.yaml"
              }
            },
            "required": [
              "filtering",
              "subject"
            ]
          }
        ]
      }
    }
  }
}